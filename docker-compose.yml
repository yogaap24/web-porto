version: '3.8'

services:
  app:
    image: ${DOCKER_USERNAME}/${IMAGE_NAME}:latest
    container_name: ${IMAGE_NAME}
    restart: unless-stopped
    working_dir: /var/www
    volumes:
      - storage_data:/var/www/storage
      - bootstrap_cache:/var/www/bootstrap/cache
      - ./.env:/var/www/.env:ro
      - webporto_code:/var/www:ro
    networks:
      - database-network
      - proxy
    env_file:
      - .env
    environment:
      SERVICE_NAME: ${IMAGE_NAME}
      SERVICE_TAGS: dev
    healthcheck:
      test: ["CMD-SHELL", "test -f /var/www/vendor/autoload.php || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: 0.5

  web:
    image: nginx:stable-alpine
    container_name: ${IMAGE_NAME}-nginx
    restart: unless-stopped
    depends_on:
      - app
    volumes:
      - ./nginx/site.conf:/etc/nginx/conf.d/default.conf:ro
      - webporto_code:/var/www:ro
    networks:
      - proxy
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: 0.5
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${IMAGE_NAME}.entrypoints=web"
      - "traefik.http.routers.${IMAGE_NAME}.rule=Host(`${APP_HOST}`)"
      - "traefik.http.routers.${IMAGE_NAME}.middlewares=${IMAGE_NAME}-redirect"
      - "traefik.http.middlewares.${IMAGE_NAME}-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.${IMAGE_NAME}-secure.entrypoints=websecure"
      - "traefik.http.routers.${IMAGE_NAME}-secure.rule=Host(`${APP_HOST}`)"
      - "traefik.http.routers.${IMAGE_NAME}-secure.tls=true"
      - "traefik.http.routers.${IMAGE_NAME}-secure.tls.certresolver=letsencrypt"
      - "traefik.http.services.${IMAGE_NAME}.loadbalancer.server.port=80"
      - "traefik.docker.network=proxy"

volumes:
  storage_data:
  bootstrap_cache:
  webporto_code:

networks:
  database-network:
    external: true
  proxy:
    external: true
