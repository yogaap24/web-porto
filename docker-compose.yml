version: "3.8"

services:
    webporto_app:
        image: ${DOCKER_USERNAME}/${IMAGE_NAME}:latest
        container_name: ${IMAGE_NAME}
        restart: unless-stopped
        working_dir: /var/www
        volumes:
            - webporto_storage:/var/www/storage
            - webporto_bootstrap_cache:/var/www/bootstrap/cache
            - ./.env:/var/www/.env
        networks:
            - database-network
            - internal_net
        env_file:
            - .env
        environment:
            SERVICE_NAME: ${IMAGE_NAME}
            SERVICE_TAGS: dev
        healthcheck:
            test:
                ["CMD-SHELL", "test -f /var/www/vendor/autoload.php || exit 1"]
            interval: 30s
            timeout: 5s
            retries: 3
        deploy:
            resources:
                limits:
                    memory: 100M
                    cpus: 0.5

    webporto_nginx:
        image: nginx:stable-alpine
        container_name: ${IMAGE_NAME}-nginx
        restart: unless-stopped
        depends_on:
            - webporto_app
        volumes:
            - ./nginx/site.conf:/etc/nginx/conf.d/default.conf:ro
        volumes_from:
            - webporto_app:ro
        voumes
        networks:
            - proxy
            - internal_net
        deploy:
            resources:
                limits:
                    memory: 100M
                    cpus: 0.5
        labels:
            - "traefik.enable=true"
            - "traefik.http.routers.${IMAGE_NAME}.entrypoints=web"
            - "traefik.http.routers.${IMAGE_NAME}.rule=Host(`${APP_HOST}`)"
            - "traefik.http.routers.${IMAGE_NAME}.middlewares=${IMAGE_NAME}-redirect"
            - "traefik.http.middlewares.${IMAGE_NAME}-redirect.redirectscheme.scheme=https"
            - "traefik.http.routers.${IMAGE_NAME}-secure.entrypoints=websecure"
            - "traefik.http.routers.${IMAGE_NAME}-secure.rule=Host(`${APP_HOST}`)"
            - "traefik.http.routers.${IMAGE_NAME}-secure.tls=true"
            - "traefik.http.routers.${IMAGE_NAME}-secure.tls.certresolver=letsencrypt"
            - "traefik.http.services.${IMAGE_NAME}.loadbalancer.server.port=80"
            - "traefik.docker.network=proxy"

volumes:
    webporto_storage:
    webporto_bootstrap_cache:

networks:
    database-network:
        external: true
    proxy:
        external: true
    internal_net:
        driver: bridge
